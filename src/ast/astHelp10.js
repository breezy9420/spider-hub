import {readFile, writeFile, getJsByAst, getAstByJs} from "../../util/ast.js";
import types from "@babel/types";
import traverseModule from "@babel/traverse";
import * as path from "path";
import {fileURLToPath} from "url";

const traverse = traverseModule.default || traverseModule;

function a0_0xc300() {
    return [
        "rdBAH",
        "YFyav",
        "gwoOo",
        "HzwfI",
        "FDYvY",
        "kQmZl",
        "gNKBR",
        "sgXDN",
        "ovTap",
        "lYEqm",
        "jQflp",
        "Xkihy",
        "UUsWJ",
        "kexhU",
        "mvGxf",
        "AQxya",
        "wmVvn",
        "BIfAJ",
        "ZWEza",
        "AhTnQ",
        "WnPbS",
        "IQGmV",
        "eoAup",
        "VzocD",
        "FdJnV",
        "iXfzK",
        "brkob",
        "ztpdY",
        "DKjKE",
        "krUzr",
        "lcnbk",
        "kXLJp",
        "RmrVL",
        "EnPqH",
        "hmac",
        "UZkjQ",
        "kfQzV",
        "lsXYJ",
        "UrmYQ",
        "vRwhT",
        "NdeyU",
        "OheXN",
        "nAOdo",
        "mztNH",
        "constructor",
        "wdEln",
        "Czfgl",
        "AUawo",
        "rujTb",
        "MRAKG",
        "DfibS",
        "inner",
        "Jdhjb",
        "lDcnW",
        "KGUAz",
        "fromCharCode",
        "Zhftj",
        "bgIwl",
        "dotIn",
        "ifYqA",
        "THqnW",
        "gZHVt",
        "mVodk",
        "Mfaqb",
        "uLOPY",
        "wzdaD",
        "yQHEt",
        "zTKyZ",
        "jkuqB",
        "wIAqK",
        "iQGzN",
        "IDWEe",
        "Function(arguments[0]+\"",
        "JVwAO",
        "ylqNQ",
        "kAfPt",
        "VHEaN",
        "sha224",
        "Ppopu",
        "(((.+)+)+)+$",
        "input is invalid type",
        "cXQag",
        "cJfLp",
        "xNDyB",
        "LlkQL",
        "mSwYe",
        "vgAwf",
        "bOXgk",
        "fwrdo",
        "\")()",
        "LuCOc",
        "HtZDf",
        "oDmDB",
        "dypZl",
        "bheHj",
        "OjDWL",
        "rTIzJ",
        "SLDIg",
        "inMwj",
        "iqnrF",
        "JDoqo",
        "rHunG",
        "SWVst",
        "pYsGU",
        "LLrvH",
        "charCodeAt",
        "object",
        "JUqjf",
        "veFMK",
        "qcDNZ",
        "lorpB",
        "TuvYm",
        "qCydf",
        "Mkghr",
        "block",
        "JEaqy",
        "bind",
        "JRwcB",
        "lieZx",
        "KMeXE",
        "zOQiA",
        "vHWWU",
        "[object Array]",
        "nCSIb",
        "HAKQy",
        "UJljx",
        "thgfs",
        "xbKhq",
        "oJvUl",
        "finalize",
        "ItsPR",
        "qaXQx",
        "1526888pizfsD",
        "AEEyx",
        "pPBTC",
        "xQiRr",
        "Buffer",
        "mFzMe",
        "ObjNZ",
        "skEUG",
        "plOQg",
        "UizNr",
        "lLmbR",
        "MfmbK",
        "NJaqa",
        "rkEVb",
        "yGtOb",
        "MUiyM",
        "tXGNg",
        "JujOx",
        "iWQeP",
        "bytes",
        "pwCrC",
        "rKJmQ",
        "cqCxA",
        "vlrmM",
        "PzSGl",
        "Knard",
        "PINcz",
        "chTYE",
        "cCAyl",
        "iyUjz",
        "eBfJJ",
        "NjYqG",
        "JUGgG",
        "PhNcL",
        "omjzW",
        "GUbFR",
        "jysKE",
        "NPASj",
        "DCMYa",
        "gazcs",
        "LHefU",
        "mGuTR",
        "daBFe",
        "talam",
        "TDvtU",
        "rpIRA",
        "RZAEJ",
        "zICsO",
        "LkqhB",
        "mEnOB",
        "json",
        "gnFuy",
        "FZftP",
        "ctTvr",
        "mdqKI",
        "DRJAz",
        "log",
        "VPSEa",
        "WNhij",
        "MejDz",
        "toLowerCase",
        "nINVR",
        "GQWsO",
        "vadzT",
        "CIbry",
        "Mhsga",
        "IQKwb",
        "itbgp",
        "ZDWty",
        "yQkPe",
        "ZbuiH",
        "6|5|4|0|1|3|2",
        "setUint32",
        "YXHlm",
        "hZTca",
        "StXMw",
        "ANCEo",
        "kwZOJ",
        "KHevl",
        "czfNx",
        "ASyPg",
        "mOFiX",
        "jmiZY",
        "nIHjT",
        "vVvLe",
        "TjYOv",
        "LpzOQ",
        "PCAwL",
        "BBDLT",
        "oKeyPad",
        "CKEST",
        "lBuqD",
        "vcCOS",
        "QRywK",
        "eeOmy",
        "aNoHO",
        "mPXGY",
        "ndXsp",
        "QKbqh",
        "LaYYe",
        "ptnbX",
        "gfcth",
        "RWihP",
        "HFGwN",
        "mOUVS",
        "cFpAX",
        "CkHyY",
        "hrRpm",
        "MVkwP",
        "25961eBVrvk",
        "MTfTq",
        "NKGKM",
        "UHYmM",
        "YWWGt",
        "hWyhu",
        "FntcT",
        "eFiTU",
        "wwJlM",
        "JS_SHA256_NO_NODE_JS",
        "PqkCi",
        "array",
        "{}.constructor(\"return this\")( )",
        "Adfdx",
        "utf8",
        "zDTct",
        "QddiZ",
        "SyrFG",
        "xWyXL",
        "lDzHs",
        "Zzhds",
        "WHkPr",
        "yMMqe",
        "uswGV",
        "KiOns",
        "xQRkj",
        "rHPbA",
        "KlWxo",
        "FZZNn",
        "GfbvW",
        "tqadY",
        "WCDVl",
        "unwfQ",
        "kCaTW",
        "fJFLf",
        "vbyfR",
        "lGePl",
        "VdrxB",
        "yCJhR",
        "iBgHN",
        "ditMB",
        "TMhyG",
        "pwxez",
        "Zhvgi",
        "vdCJy",
        "Pbtcb",
        "DSwyg",
        "iPxGw",
        "YeoKp",
        "VtZJW",
        "MAXQf",
        "LqHQg",
        "ajax",
        "lkdkJ",
        "GET",
        "var1",
        "VgJSO",
        "xnRJG",
        "/api/problem-detail/",
        "nCgKa",
        "GmfXh",
        "FgbiB",
        "VKFAn",
        "ijyJW",
        "ecJgs",
        "NQeRK",
        "rLXiS",
        "InBcJ",
        "join",
        "stateObject",
        "MRRkJ",
        "SUOAn",
        "YYWVL",
        "rERlD",
        "clfig",
        "dDNqW",
        "iXwOH",
        "is224",
        "hZUlU",
        "ihVOD",
        "jjTcH",
        "IubTZ",
        "ccIDV",
        "mVvNv",
        "bqaCZ",
        "YMYSX",
        "qUSUS",
        "ckMCM",
        "kogrW",
        "dcBoy",
        "aPPjT",
        "XrWgf",
        "UmUfP",
        "OBOaS",
        "rQhHx",
        "VKpBs",
        "zfeLZ",
        "BjUoK",
        "OvIWd",
        "iJyUh",
        "eXDZA",
        "yZgJh",
        "djcrE",
        "vzpNK",
        "SRBar",
        "start",
        "vsudy",
        "WVGHh",
        "RPdyq",
        "LArGt",
        "AOKXh",
        "yMPyl",
        "eiqdy",
        "iFywV",
        "teKsI",
        "ijyeS",
        "POuGD",
        "nHVrP",
        "bfTUs",
        "eNKyI",
        "aekLb",
        "isArray",
        "kLqfJ",
        "OhJsK",
        "HcHba",
        "IouZE",
        "/data/?",
        "kLihb",
        "dFeEJ",
        "kpSYl",
        "ArzsC",
        "nixnO",
        "IOVjN",
        "XqlvE",
        "vrsGQ",
        "function",
        "WDYuW",
        "wwUJB",
        "JSTaz",
        "NyVGW",
        "YHukl",
        "hBytes",
        "CIIDw",
        "GGFjj",
        "lOFOt",
        "FgNut",
        "EBEpZ",
        "PiCad",
        "HMaXu",
        "wiqNl",
        "uATUx",
        "IzyrV",
        "VnFzW",
        "AySbk",
        "vYKQS",
        "aMaDF",
        "node",
        "HdCiF",
        "dEPjF",
        "HwrwC",
        "qSsxU",
        "pfoVm",
        "ZcTIi",
        "ckPEB",
        "auZfN",
        "warn",
        "cnBKt",
        "QdjPq",
        "duflQ",
        "SKhUI",
        "arrayBuffer",
        "WSebe",
        "DAbzr",
        "osQhV",
        "hxnds",
        "UQtwD",
        "iMnrX",
        "UfNVR",
        "OuKSL",
        "Ypens",
        "MRcrX",
        "iXgJa",
        "zTldz",
        "aklcp",
        "714550gBlbpB",
        "ERrZo",
        "AptPO",
        "let ",
        "RgFhG",
        "diNnd",
        "lCxVG",
        "wskgQ",
        "RLyRf",
        "gHIGz",
        "eWlAW",
        "SStPh",
        "OImyv",
        "WSAwJ",
        "tKvKD",
        "zUhhx",
        "amd",
        "Qpfzl",
        "TwqZo",
        "kDgmR",
        "NMpOx",
        "jfBhM",
        "uloKq",
        "OQkmL",
        "dMaAO",
        "950624hxOvwH",
        "glpwu",
        "zGgWY",
        "fIoQv",
        "mdSdj",
        "eyret",
        "nrxZT",
        "wQlUy",
        "TrAGI",
        "ZeMaK",
        "fyrXJ",
        "createHash",
        "PxnWx",
        "ccmTl",
        "QQBYo",
        "hLBtT",
        "ScmZc",
        "XBzwH",
        "Fhurz",
        "ipCEE",
        "zifJH",
        "WiNPp",
        "QdBor",
        "SLmOQ",
        "geYNT",
        "iJJpq",
        "mnkJW",
        "IZaCT",
        "prototype",
        "WtjSW",
        " = ",
        "WJvJf",
        "zhWFM",
        "szXbY",
        "VQJVu",
        "giLAm",
        "vnOvX",
        "piWxA",
        "MmXlq",
        "gDeAv",
        "ORMGE",
        "nWCbH",
        "CkNuO",
        "error",
        "NxUlR",
        "Ixxew",
        "ghkXA",
        "EOqrj",
        "sslvE",
        "afGgZ",
        "RcLmR",
        "VTOxC",
        "nkqir",
        "EdcuW",
        "RompG",
        "gbUHq",
        "jKaNn",
        "function *\\( *\\)",
        "SUiGP",
        "EpSnZ",
        "exception",
        "YmHHF",
        "FHpiP",
        "jekrt",
        "FucFe",
        "GOFMu",
        "MbRsm",
        "sjXsD",
        "PlDFN",
        "dICZG",
        "CreFX",
        "AqPCW",
        "xPtXq",
        "vdkDa",
        "zBKhk",
        "jZrgg",
        "MJRoG",
        "OmYMu",
        "pkyAT",
        "nIZDK",
        "biFhd",
        "FoQTb",
        "CHgdY",
        "4|1|3|0|2|5",
        "NdkxR",
        "zclYo",
        "hisQq",
        "WiaAj",
        "ePycN",
        "flllA",
        "qpHKp",
        "aWVIV",
        "UbMIw",
        "InZrO",
        "ioUiQ",
        "DCxNL",
        "UorzL",
        "MLtaq",
        "VHFZT",
        "RWioP",
        "IuSVf",
        "GTAtl",
        "qksww",
        "2|0|5|4|6|3|1",
        "kGhZY",
        "RHWqz",
        "mTtay",
        "GPQHa",
        "ySboE",
        "init",
        "cczpA",
        "uLupG",
        "vMeop",
        "wpNbG",
        "JIuYq",
        "BkaxD",
        "bPmBw",
        "rFklZ",
        "chain",
        "eDhpi",
        "airui",
        "viWRJ",
        "SMrcC",
        "qrbSW",
        "xPtLH",
        "LhihS",
        "bQoSF",
        "ljFHE",
        "EsLil",
        "3078966SAqBcJ",
        "plfNl",
        "jkzuY",
        "NMjtZ",
        "umLAw",
        "fvdQA",
        "bBYhY",
        "qGEFz",
        "bugger",
        "exatP",
        "QSUcx",
        "create",
        "rCXFO",
        "LxJxt",
        "MvbZW",
        "finalized",
        "YXBig",
        "UDjqK",
        "ldLzA",
        "icXLv",
        "jELkf",
        "nlPHf",
        "baDvg",
        "MhRDk",
        "mOQrw",
        "zkCYT",
        "gUlqI",
        "fXNdd",
        "dVlSn",
        "DBIBB",
        "AYpip",
        "uhVwz",
        "IHsbq",
        "vpSIK",
        "YlBvJ",
        "cDpCZ",
        "OBNgI",
        "wvkra",
        "nNucx",
        "YuonY",
        "HPwWf",
        "FMfiq",
        "lFsGo",
        "xBBdb",
        "mXsmO",
        "jWcxF",
        "table",
        "TcfWQ",
        "rHjrz",
        "KLbHC",
        "ZzKBr",
        "ExbGo",
        "MAeqJ",
        "OSoRt",
        "EZMiE",
        "UVUMi",
        "eUvGm",
        "MWvHy",
        "FNFmU",
        "update",
        "uRQRT",
        "vxWLS",
        "KXEBG",
        "rMhDq",
        "RypjX",
        "substr",
        "length",
        "oxPid",
        "uvyiB",
        "RJLQl",
        "dvMVO",
        "DEBFm",
        "Error fetching problem details:",
        "GGtgC",
        "string",
        "llWBT",
        "QWxxN",
        "DwSsk",
        "gUVaA",
        "wcUqy",
        "TmZUZ",
        "LkPaf",
        "WJzKY",
        "Mkidp",
        "JmaRp",
        "OdDgv",
        "CJAHm",
        "eMnXj",
        "aEfsV",
        "JS_SHA256_NO_BUFFER_FROM",
        "SAKFA",
        "GqbaA",
        "ugYlU",
        "hashed",
        "mqLhR",
        "14OyvscV",
        "FDPad",
        "toString",
        "nRiSN",
        "NFwtK",
        "dpZvr",
        "EkdlG",
        "var5",
        "jZSWe",
        "FHgoZ",
        "svLrT",
        "YgGhb",
        "kNVOk",
        "SpDNu",
        "UUEdF",
        "LYvum",
        "gWihT",
        "iQHSS",
        "SGNHh",
        "eQYhC",
        "amFcA",
        "sharedMemory",
        "YPGut",
        "TlGFS",
        "cagVF",
        "fLAkS",
        "XoKCL",
        "PMDBk",
        "hiIxA",
        "XFzNe",
        "PoFJC",
        "VTnYM",
        "CtPxd",
        "first",
        "CJNRd",
        "xTkwh",
        "CwPNE",
        "replace",
        "4|0|3|1|2",
        "XSVEb",
        "dhcmi",
        "tFzMC",
        "MBTbV",
        "AyQYW",
        "EiKMl",
        "CkPNw",
        "FoYLC",
        "mrYkA",
        "ktzrg",
        "qcpHx",
        "LrMTM",
        "TJmCH",
        "NOukS",
        "WilCF",
        "DxRiU",
        "jYwzF",
        "gjzTC",
        "oUuvN",
        "OzcUq",
        "EVOgu",
        "TceiB",
        "LLLcL",
        "IeAVx",
        "test",
        "BnaoJ",
        "IreJZ",
        "QwBOj",
        "mnYHh",
        "wUmmA",
        "TfsFI",
        "dPNLu",
        "FNoBW",
        "vXPtq",
        "ZyPDi",
        "GqkAN",
        "ifsiB",
        "ajaxPrefilter",
        "crypto",
        "search",
        "xLtVT",
        "GTtVN",
        "jQiWL",
        "bYHnQ",
        "blocks",
        "vYYqg",
        "TcWTv",
        "uQKYx",
        "gger",
        "JofVO",
        "__proto__",
        "aawHN",
        "TTnuO",
        "nhlfx",
        "IOEOk",
        "hKtLP",
        "sqzKO",
        "isView",
        "eYoqT",
        "CFCvT",
        "UyyWC",
        "gWEpC",
        "CzkGe",
        "uUUvI",
        "GdVbm",
        "JMcTP",
        "jjhiD",
        "cSbcA",
        "vYfSX",
        "KwZCw",
        "eXvkW",
        "VarYz",
        "PJaUl",
        "wSxnD",
        "hYvFO",
        "fRTUG",
        "Chths",
        "ngMOh",
        "QFTzQ",
        "VpQZW",
        "dmVLt",
        "aQoSZ",
        "CuoNO",
        "XZwcS",
        "tIslR",
        "\\+\\+ *(?:[a-zA-Z_$][0-9a-zA-Z_$]*)",
        "gtHwv",
        "ZCNNY",
        "wXOMV",
        "TxWgZ",
        "4|0|3|2|1",
        "1347048PPTMZe",
        "PhAuE",
        "aegOi",
        "push",
        "mjult",
        "oCMug",
        "zLBvz",
        "EWCuI",
        "hash",
        "ZcFAA",
        "OMTVN",
        "aDIHv",
        "RBpJU",
        "RKqCS",
        "undefined",
        "tYJGS",
        "return (function() ",
        "nvgVK",
        "CAprF",
        "TXBhj",
        "iDwsf",
        "xThRU",
        "ocCQx",
        "MRtOV",
        "ighfU",
        "vwaze",
        "KcCXS",
        "VcAHN",
        "viKtM",
        "zIXUf",
        "Svgzw",
        "zUnGQ",
        "JAMdw",
        "jlciD",
        "TPsmd",
        "SVIax",
        "qgMkv",
        "split",
        "dcTiN",
        "StRIs",
        "Pytrs",
        "QANjk",
        "qyfwL",
        "ICFEk",
        "pwZKY",
        "hJynn",
        "Njaow",
        "SawVc",
        "fiBUc",
        "gokBZ",
        "bhwLK",
        "BHEkt",
        "JeYan",
        "eFksO",
        "EPwqm",
        "UGybM",
        "VsrWB",
        "iCWZQ",
        "UGRoX",
        "JS_SHA256_NO_ARRAY_BUFFER_IS_VIEW",
        "console",
        "kpgBC",
        "sntYM",
        "var2",
        "BaVLO",
        "hex",
        "COUwz",
        "lxJRV",
        "ieFrz",
        "headers",
        "VzEEA",
        "WEnub",
        "FoDlD",
        "KZKTn",
        "JSshz",
        "obneN",
        "KuBgb",
        "cJwYR",
        "ZmvTJ",
        "KScFA",
        "versions",
        "GUKZY",
        "CfvCt",
        "BErah",
        "BcTcP",
        "ozprI",
        "VhSIP",
        "UZUqb",
        "GVsln",
        "rAaRP",
        "PisgC",
        "sha256",
        "ERaeX",
        "YEaQQ",
        "EKCgk",
        "MqodG",
        "tjNrZ",
        "hNmpP",
        "LtbGM",
        "info",
        "CzwDm",
        "HFoyT",
        "UXSJI",
        "bpzEO",
        "sUCCj",
        "eURmt",
        "mQJTU",
        "dEtpq",
        "jigZY",
        "lLuvG",
        "emZUS",
        "ixmrv",
        "aBoQx",
        "FkEaJ",
        "apply",
        "url",
        "xHJAX",
        "JS_SHA256_NO_ARRAY_BUFFER",
        "pkYWZ",
        "vmpXG",
        "KkqGz",
        "VsZbf",
        "counter",
        "VCrgk",
        "crbGR",
        "byrPQ",
        "BsGal",
        "oQAcn",
        "VRIKj",
        "wxFBf",
        "Igjsm",
        "BgklB",
        "OFNsS",
        "uUkhX",
        "rutSi",
        "EopFy",
        "WfSiC",
        "WhKzD",
        "digest",
        "xaeXw",
        "random",
        "lastByteIndex",
        "buffer",
        "jdtKD",
        "ZkXke",
        "JwTwR",
        "padwt",
        "lZrcn",
        "zpHAJ",
        "LjxxM",
        "call",
        "fAAqn",
        "IqMFj",
        "KfYKX",
        "floor",
        "ovHQF",
        "lZWRE",
        "HXhku",
        "YxqLB",
        "HAouS",
        "SRFlb",
        "HBHtN",
        "GLwKj",
        "kBiDN",
        "PaXsd",
        "qzXna",
        "while (true) {}",
        "zqseK",
        "xkkRo",
        "uyNAW",
        "1725774pfZZZY",
        "sbgZC",
        "srpCP",
        "NHQoh",
        "sRfYT",
        "from",
        "qMQSc",
        "wGdoD",
        "uosuF",
        "var3",
        "KClND",
        "wDbYl",
        "PnRdH",
        "ByhaA",
        "CrHdV",
        "pLKrT",
        "oQaHw",
        "Whmfn",
        "njRVR"
    ];
}

function a0_0x554b(_0x42aea5, _0x408013) {
    var _0x5a0b06 = a0_0xc300();
    return a0_0x554b = function (_0x318f9a, _0x58f1a5) {
        _0x318f9a = _0x318f9a - 0x81;
        var _0x177ba1 = _0x5a0b06[_0x318f9a];
        return _0x177ba1;
    }, a0_0x554b(_0x42aea5, _0x408013);
}

// 去除未引用代码
function removeUnusedCode(path) {
    const binding = path.scope.getBinding(path.node.name);
    if (binding) {
        const {referencePaths} = binding;
        if (referencePaths.length === 0) {
            if (types.isVariableDeclarator(path.parentPath)) {
                path.parentPath.remove();
                console.log(`remove ${path.node.name}`);
            }
        }
    }
}

function hexStringToStr(hexString) {
    const reg = /\\x[0-9a-fA-F]{2,8}|\\u[0-9a-fA-F]{4}|\\u\{[0-9a-fA-F]{1,6}\}/g;
    return hexString.replaceAll(reg, (match) => {
        return String.fromCharCode(parseInt(match.slice(2), 16));
    });
}

function decryptHexStr(originCode) {
    const reg = /['"`]([^'"`]*?(\\x[0-9a-fA-F]{2}|\\u[0-9a-fA-F]{4}|\\u\{[0-9a-fA-F]{1,6}\})+[^'"`]*?)['"`]/g;
    return originCode.replaceAll(reg, (match) => {
        const plainText = hexStringToStr(match);
        if (["'\\x3b\\x0a'"].includes(match)) {
            return match;
        }
        console.log(`${match} => ${plainText}`);
        return plainText;
    });
}

function encryptStr_a0_0x554b(path, name) {
    if (types.isIdentifier(path.node.init, {name})) {
        const leftName = path.node.id.name;
        const binding = path.scope.getBinding(leftName);
        if (binding) {
            const {referencePaths} = binding;
            for (const p of referencePaths) {
                if (types.isCallExpression(p.parentPath)) {
                    const [param1] = p.parentPath.node.arguments;
                    const plainText = a0_0x554b(param1.value);
                    p.parentPath.replaceWith(types.stringLiteral(plainText));
                    console.log(`${leftName}('${param1.value}') => ${plainText}`);
                } else {
                    encryptStr_a0_0x554b(p.parentPath, leftName);
                }
            }
        }
    }
}

async function main() {
    const encryptJsPath = path.resolve(path.dirname(fileURLToPath(import.meta.url)), "./page10.js");
    let jsCode = await readFile(encryptJsPath);
    jsCode = decryptHexStr(jsCode);
    const ast = getAstByJs(jsCode);
    // 字符串解密
    traverse(ast, {
        VariableDeclarator(path) {
            encryptStr_a0_0x554b(path, "a0_0x554b");
        }
    });
    let newAst = getAstByJs(getJsByAst(ast));
    traverse(newAst, {
        Identifier(path) {
            removeUnusedCode(path);
        }
    });
    const newJsCode = getJsByAst(ast);
    const outputJsPath = path.resolve(path.dirname(fileURLToPath(import.meta.url)), "./page10_decrypt.js");
    writeFile(outputJsPath, newJsCode);
    // writeFile(outputJsPath, jsCode);
}

main();
